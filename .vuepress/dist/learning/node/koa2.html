<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Koa2框架从0开始构建预告片网站 | Jerry articles</title>
    <meta name="description" content="writing some notes">
    <link rel="icon" href="/logo.png">
  <meta name="theme-color" content="#3eaf7c">
    
    <link rel="preload" href="/assets/css/87.styles.24791bc4.css" as="style"><link rel="preload" href="/assets/js/app.d5e53e1d.js" as="script"><link rel="preload" href="/assets/js/52.893d9d3e.js" as="script"><link rel="prefetch" href="/assets/js/44.d65c3fd7.js"><link rel="prefetch" href="/assets/js/1.74ee5cb4.js"><link rel="prefetch" href="/assets/js/2.5e966c72.js"><link rel="prefetch" href="/assets/js/3.ba142829.js"><link rel="prefetch" href="/assets/js/4.0b295d16.js"><link rel="prefetch" href="/assets/js/5.18a1aae6.js"><link rel="prefetch" href="/assets/js/6.398ea462.js"><link rel="prefetch" href="/assets/js/7.f86e1f4f.js"><link rel="prefetch" href="/assets/js/8.fba70220.js"><link rel="prefetch" href="/assets/js/9.227b7ec9.js"><link rel="prefetch" href="/assets/js/10.4a4ce9a3.js"><link rel="prefetch" href="/assets/js/11.f8fc7706.js"><link rel="prefetch" href="/assets/js/12.b7e89bda.js"><link rel="prefetch" href="/assets/js/13.5fdfcec2.js"><link rel="prefetch" href="/assets/js/14.3dc51b0b.js"><link rel="prefetch" href="/assets/js/15.33eb5846.js"><link rel="prefetch" href="/assets/js/16.a7f5d3a8.js"><link rel="prefetch" href="/assets/js/17.30d25447.js"><link rel="prefetch" href="/assets/js/18.7abc2491.js"><link rel="prefetch" href="/assets/js/19.86f172de.js"><link rel="prefetch" href="/assets/js/20.6657cd0f.js"><link rel="prefetch" href="/assets/js/21.fb4600d8.js"><link rel="prefetch" href="/assets/js/22.7e1c6298.js"><link rel="prefetch" href="/assets/js/23.e4d6bb01.js"><link rel="prefetch" href="/assets/js/24.6923d01b.js"><link rel="prefetch" href="/assets/js/25.8369a5c0.js"><link rel="prefetch" href="/assets/js/26.2cfff635.js"><link rel="prefetch" href="/assets/js/27.65d0161e.js"><link rel="prefetch" href="/assets/js/28.f9316746.js"><link rel="prefetch" href="/assets/js/29.eb9a13f1.js"><link rel="prefetch" href="/assets/js/30.a3daff3f.js"><link rel="prefetch" href="/assets/js/31.9b6d735c.js"><link rel="prefetch" href="/assets/js/32.1b515589.js"><link rel="prefetch" href="/assets/js/33.bc4067a3.js"><link rel="prefetch" href="/assets/js/34.b605b945.js"><link rel="prefetch" href="/assets/js/35.ef549f8d.js"><link rel="prefetch" href="/assets/js/36.ff330d99.js"><link rel="prefetch" href="/assets/js/37.05b616a8.js"><link rel="prefetch" href="/assets/js/38.06d82b3a.js"><link rel="prefetch" href="/assets/js/39.13f6ee7d.js"><link rel="prefetch" href="/assets/js/40.049a9278.js"><link rel="prefetch" href="/assets/js/41.52a73d2a.js"><link rel="prefetch" href="/assets/js/42.3cb0a12b.js"><link rel="prefetch" href="/assets/js/43.4f7a4838.js"><link rel="prefetch" href="/assets/js/0.9b65f788.js"><link rel="prefetch" href="/assets/js/45.019f0d0e.js"><link rel="prefetch" href="/assets/js/46.e2f641de.js"><link rel="prefetch" href="/assets/js/47.7d2807d0.js"><link rel="prefetch" href="/assets/js/48.c289b0d2.js"><link rel="prefetch" href="/assets/js/49.e9e2104f.js"><link rel="prefetch" href="/assets/js/50.59ff6c8f.js"><link rel="prefetch" href="/assets/js/51.01c35bd6.js"><link rel="prefetch" href="/assets/js/53.072a7f52.js"><link rel="prefetch" href="/assets/js/54.1919cf1c.js"><link rel="prefetch" href="/assets/js/55.efdc8c66.js"><link rel="prefetch" href="/assets/js/56.1b3dc9a5.js"><link rel="prefetch" href="/assets/js/57.554746b2.js"><link rel="prefetch" href="/assets/js/58.7f250301.js"><link rel="prefetch" href="/assets/js/59.1df35820.js"><link rel="prefetch" href="/assets/js/60.d3c44ec1.js"><link rel="prefetch" href="/assets/js/61.34d3acb0.js"><link rel="prefetch" href="/assets/js/62.04a4488a.js"><link rel="prefetch" href="/assets/js/63.b2816254.js"><link rel="prefetch" href="/assets/js/64.31360c13.js"><link rel="prefetch" href="/assets/js/65.f9703bf4.js"><link rel="prefetch" href="/assets/js/66.ec002130.js"><link rel="prefetch" href="/assets/js/67.8ae6dfaa.js"><link rel="prefetch" href="/assets/js/68.48da390a.js"><link rel="prefetch" href="/assets/js/69.701e8421.js"><link rel="prefetch" href="/assets/js/70.b62351e8.js"><link rel="prefetch" href="/assets/js/71.5a2bab01.js"><link rel="prefetch" href="/assets/js/72.c7d1c4cf.js"><link rel="prefetch" href="/assets/js/73.639526a2.js"><link rel="prefetch" href="/assets/js/74.9c56871b.js"><link rel="prefetch" href="/assets/js/75.3e412c63.js"><link rel="prefetch" href="/assets/js/76.c83a62ea.js"><link rel="prefetch" href="/assets/js/77.af3c1479.js"><link rel="prefetch" href="/assets/js/78.d045cf75.js"><link rel="prefetch" href="/assets/js/79.5cef8852.js"><link rel="prefetch" href="/assets/js/80.77e15e66.js"><link rel="prefetch" href="/assets/js/81.b213c24d.js"><link rel="prefetch" href="/assets/js/82.6b46b61a.js"><link rel="prefetch" href="/assets/js/83.14bb5e57.js"><link rel="prefetch" href="/assets/js/84.165e707a.js"><link rel="prefetch" href="/assets/js/85.70a6af01.js"><link rel="prefetch" href="/assets/js/86.67ca9fc9.js">
    <link rel="stylesheet" href="/assets/css/87.styles.24791bc4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Jerry articles
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/learning/fe/" class="nav-link">前端</a></li><li class="dropdown-item"><!----><a href="/learning/node/" class="nav-link router-link-active">Node</a></li><li class="dropdown-item"><!----><a href="/learning/python/" class="nav-link">Python</a></li><li class="dropdown-item"><!----><a href="/learning/other/" class="nav-link">other</a></li></ul></div></div><div class="nav-item"><a href="https://jerryshi.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/reading/" class="nav-link">读书笔记</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">学习笔记</span><span class="arrow right"></span></a><ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----><a href="/learning/fe/" class="nav-link">前端</a></li><li class="dropdown-item"><!----><a href="/learning/node/" class="nav-link router-link-active">Node</a></li><li class="dropdown-item"><!----><a href="/learning/python/" class="nav-link">Python</a></li><li class="dropdown-item"><!----><a href="/learning/other/" class="nav-link">other</a></li></ul></div></div><div class="nav-item"><a href="https://jerryshi.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Koa2框架从0开始构建预告片网站</span><!----></p><ul class="sidebar-group-items"><li><a href="/learning/node/koa2.html#第1章-2018-年的编程姿势" class="sidebar-link">第1章 2018 年的编程姿势</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#_1-3-毫不犹豫的使用promise" class="sidebar-link">1-3 毫不犹豫的使用promise</a></li></ul></li><li><a href="/learning/node/koa2.html#第2章-必会-es6-7-语法特性与规范" class="sidebar-link">第2章 必会 ES6-7 语法特性与规范</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#这些年javascript处理异步的几个阶段" class="sidebar-link">这些年JavaScript处理异步的几个阶段</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#babel环境配置与import、export、async和await" class="sidebar-link">babel环境配置与import、export、async和await</a></li></ul></li><li><a href="/learning/node/koa2.html#第3章-层层学习-koa-框架的-api" class="sidebar-link">第3章 层层学习 Koa 框架的 API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#koa核心对象" class="sidebar-link">Koa核心对象</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#koa源码之-application" class="sidebar-link">Koa源码之 Application</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#koa源码之middlewares" class="sidebar-link">Koa源码之middlewares</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#koa-compose的纯函数与尾递归" class="sidebar-link">Koa-Compose的纯函数与尾递归</a></li></ul></li><li><a href="/learning/node/koa2.html#第4章-koa2-与-koa1-、express-框架对比" class="sidebar-link">第4章 Koa2 与 Koa1 、Express 框架对比</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#koa-与-express-选型" class="sidebar-link">koa 与 express 选型</a></li></ul></li><li><a href="/learning/node/koa2.html#第5章-从-0-开发一个电影预告片网站" class="sidebar-link">第5章 从 0 开发一个电影预告片网站</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#关于构建工具pracel解决的问题" class="sidebar-link">关于构建工具pracel解决的问题</a></li></ul></li><li><a href="/learning/node/koa2.html#第6章-利用爬虫搞定网站基础数据" class="sidebar-link">第6章 利用爬虫搞定网站基础数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#利用puppeteer爬取和分析电影列表" class="sidebar-link">利用puppeteer爬取和分析电影列表</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#同步和异步物理案例" class="sidebar-link">同步和异步物理案例</a></li></ul></li><li><a href="/learning/node/koa2.html#第7章-彩蛋篇-高难度拔高干货-深度理解-node-js-异步-io-模型" class="sidebar-link">第7章 彩蛋篇 - [高难度拔高干货] 深度理解 Node.js 异步 IO 模型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learning/node/koa2.html#第8章-实战篇-在-koa-中向-mongodb-建立数据模型" class="sidebar-link">第8章 实战篇 - 在 Koa 中向 MongoDB 建立数据模型</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learning/node/koa2.html#第9章-实战篇-为网站增加路由与控制器层对外提供-api-服务" class="sidebar-link">第9章 实战篇 - 为网站增加路由与控制器层对外提供 API 服务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#_9-1" class="sidebar-link">9-1</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#_9-2" class="sidebar-link">9-2</a></li><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#_9-3" class="sidebar-link">9-3</a></li></ul></li><li><a href="/learning/node/koa2.html#第10章-实战篇-集成-antdesign-与-parcel-打通前后端与构建" class="sidebar-link">第10章 实战篇 - 集成 AntDesign 与 Parcel 打通前后端与构建</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learning/node/koa2.html#_10-1-配置babel-postcss-支持parcel打包" class="sidebar-link">10-1 配置babel postcss 支持parcel打包</a></li></ul></li><li><a href="/learning/node/koa2.html#第11章-实战篇-实现网站前端路由与页面功能" class="sidebar-link">第11章 实战篇 - 实现网站前端路由与页面功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learning/node/koa2.html#第12章-实战篇-实现后台登录权限与管理功能" class="sidebar-link">第12章 实战篇 - 实现后台登录权限与管理功能</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learning/node/koa2.html#第13章-服务器部署与发布" class="sidebar-link">第13章 服务器部署与发布</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/learning/node/koa2.html#第14章-课程总结与展望" class="sidebar-link">第14章 课程总结与展望</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="koa2框架从0开始构建预告片网站"><a href="#koa2框架从0开始构建预告片网站" aria-hidden="true" class="header-anchor">#</a> Koa2框架从0开始构建预告片网站</h1><p>[TOC]</p><h2 id="第1章-2018-年的编程姿势"><a href="#第1章-2018-年的编程姿势" aria-hidden="true" class="header-anchor">#</a> 第1章 2018 年的编程姿势</h2><h3 id="_1-3-毫不犹豫的使用promise"><a href="#_1-3-毫不犹豫的使用promise" aria-hidden="true" class="header-anchor">#</a> 1-3 毫不犹豫的使用promise</h3><ul><li><code>https://www.promisejs.org/</code></li><li>promise不是简单的语法糖，而是一个设计规范，有着各种各样的库去实现这套规范，进而向我们提供Promise接口能力的函数。</li></ul><h2 id="第2章-必会-es6-7-语法特性与规范"><a href="#第2章-必会-es6-7-语法特性与规范" aria-hidden="true" class="header-anchor">#</a> 第2章 必会 ES6-7 语法特性与规范</h2><ul><li>箭头函数：跟父作用域共享this</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 箭头函数经典栗子</span>
<span class="token keyword">const</span> jerry <span class="token operator">=</span> <span class="token punctuation">{</span>
    age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span>
    say<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'age: '</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sayWithThis<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> _this <span class="token operator">=</span> <span class="token keyword">this</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'_this age: '</span><span class="token punctuation">,</span> _this<span class="token punctuation">.</span>age<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sayWithArrow<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'arrow age: '</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    sayWithGlobalArrow<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'global arrow age: '</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token comment">// --&gt; global arrow age:  undefined</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="这些年javascript处理异步的几个阶段"><a href="#这些年javascript处理异步的几个阶段" aria-hidden="true" class="header-anchor">#</a> 这些年JavaScript处理异步的几个阶段</h3><p>第一阶段：<code>callback</code></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">readFile</span> <span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">readFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第二阶段：<code>promise</code></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">readFileAsync</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">else</span> <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">readFileAsync</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>data <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第三阶段：<code>co + Generator + Promisify</code></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">yield</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span>

  data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>第四阶段：<code>async</code></p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> readAsync <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">init</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">readAsync</span><span class="token punctuation">(</span><span class="token string">'../package.json'</span><span class="token punctuation">)</span>

  data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>一开始我没明白<code>co+generator+promise</code>是什么意思，后来发现原来co是把函数暂停了异步的结果，等到异步结果出来后再去执行后续的代码。</p><h3 id="babel环境配置与import、export、async和await"><a href="#babel环境配置与import、export、async和await" aria-hidden="true" class="header-anchor">#</a> babel环境配置与import、export、async和await</h3><p>配置babel环境</p><ul><li><code>npm i -D babel-cli babel-preset-env</code></li><li>add <code>.babelrc</code></li></ul><p><code>ReferenceError: regeneratorRuntime is not defined</code> 重新配置babel</p><ul><li><code>npm i -S babel-plugin-transform-runtime babel-runtime</code></li><li>修改 <code>.babelrc</code></li></ul><h2 id="第3章-层层学习-koa-框架的-api"><a href="#第3章-层层学习-koa-框架的-api" aria-hidden="true" class="header-anchor">#</a> 第3章 层层学习 Koa 框架的 API</h2><h3 id="koa核心对象"><a href="#koa核心对象" aria-hidden="true" class="header-anchor">#</a> Koa核心对象</h3><div class="language-js extra-class"><pre class="language-js"><code>Koa           Epxress
<span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">===</span><span class="token operator">=</span>
<span class="token constant">HTTP</span>  接收  解析  响应
中间件      执行上下文

Application   Context
Request      Response
Middlewares
Session      Cookie
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Jerry Shi - '</span> <span class="token operator">+</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4441</span><span class="token punctuation">)</span>
</code></pre></div><ul><li>Koa和Epxress一样，是一个Web服务框架，能够接收接收、解析和响应HTTP请求。</li><li>Koa的全链路组合以后就是一个应用服务对象，这个对象内部有application、context、request、response、middlewares等对象。</li><li>上述代码中 <code>async</code> 、 <code>ctx</code> 、 <code>next</code> 、整个<code>app.use</code>传入的function <code>ctx.body</code> 各是什么？</li></ul><h3 id="koa源码之-application"><a href="#koa源码之-application" aria-hidden="true" class="header-anchor">#</a> Koa源码之 Application</h3><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token keyword">extends</span> <span class="token class-name">Emitter</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>proxy <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>subdomainOffset <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Use the given middleware `fn`.
   *
   * Old-style middleware will be converted.
   *
   * @param {Function} fn
   * @return {Application} self
   * @api public
   */</span>

  <span class="token function">use</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Return a request handler callback
   * for node's native http server.
   */</span>

  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fnMiddleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onerror</span> <span class="token operator">=</span> err <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleResponse</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">onFinished</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">fnMiddleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>onerror<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> context<span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>app <span class="token operator">=</span> request<span class="token punctuation">.</span>app <span class="token operator">=</span> response<span class="token punctuation">.</span>app <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>req <span class="token operator">=</span> request<span class="token punctuation">.</span>req <span class="token operator">=</span> response<span class="token punctuation">.</span>req <span class="token operator">=</span> req<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>res <span class="token operator">=</span> request<span class="token punctuation">.</span>res <span class="token operator">=</span> response<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span>
    request<span class="token punctuation">.</span>ctx <span class="token operator">=</span> response<span class="token punctuation">.</span>ctx <span class="token operator">=</span> context<span class="token punctuation">;</span>
    request<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span>
    response<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> request<span class="token punctuation">.</span>originalUrl <span class="token operator">=</span> req<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>cookies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookies</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      keys<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>keys<span class="token punctuation">,</span>
      secure<span class="token punctuation">:</span> request<span class="token punctuation">.</span>secure
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span>ip <span class="token operator">=</span> request<span class="token punctuation">.</span>ips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">||</span> req<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>remoteAddress <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>accept <span class="token operator">=</span> request<span class="token punctuation">.</span>accept <span class="token operator">=</span> <span class="token function">accepts</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    context<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// allow bypassing koa</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span> <span class="token operator">===</span> ctx<span class="token punctuation">.</span>respond<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>writable<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> ctx<span class="token punctuation">.</span>status<span class="token punctuation">;</span>

  <span class="token comment">// ignore body</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>statuses<span class="token punctuation">.</span>empty<span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// strip headers</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'HEAD'</span> <span class="token operator">==</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent <span class="token operator">&amp;&amp;</span> <span class="token function">isJSON</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// status body</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>message <span class="token operator">||</span> <span class="token function">String</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text'</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// responses</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'string'</span> <span class="token operator">==</span> <span class="token keyword">typeof</span> body<span class="token punctuation">)</span> <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>body <span class="token keyword">instanceof</span> <span class="token class-name">Stream</span><span class="token punctuation">)</span> <span class="token keyword">return</span> body<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// body: json</span>
  body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>headersSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>length <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>当我们import一个<code>Koa</code>时，其实是暴露了一个<code>Application</code>类，它继承了<code>Emitter</code>，就以为这这个类可以直接为自定义事件注册回调函数，也可以触发一些事件，同时可以捕获到其它地方捕捉到的事件，那就以为着它有耳朵和手，可以听到一些动静之后，做一些事件。</li><li>Koa-Compose对应中间件的函数数组，Koa中的所有中间件都必须是中间件数组，数组中的每个值都必须是函数，这点需要注意。Koa-Compose实现的非常精妙，执行过程中的next都是在它里面传入后往下进行的整个流程的运转的，此源码应该读读。</li><li>context 整个运行服务的上下文，context里不仅能访问到HTTP来源所携带的信息以及方法，也能访问到给用户返回数据的方法</li><li>读源码时，可以使用删减法来读，把非核心不重要的代码删除后再来整体阅读。看看它核心解决了什么问题，是怎么解决的</li><li><code>application.js</code> 提供一种能力：通过它所new的实例后，这个实例就能使用它的能力，它的能力包括传入中间件use、监听端口生成服务器实例，生成之后能够在nodejs里通过拿到进来的http请求，对这个请求逐层的过中间件数组，最后把过完之后的结果交给它内部的<code>handleRespose</code>来处理响应</li></ul><h3 id="koa源码之middlewares"><a href="#koa源码之middlewares" aria-hidden="true" class="header-anchor">#</a> Koa源码之middlewares</h3><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mid1 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'Hi'</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body <span class="token operator">+</span> <span class="token string">' There'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mid2 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'text/html; charset=utf-8'</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mid3 <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid1<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid2<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>mid3<span class="token punctuation">)</span>
</code></pre></div><ul><li>koa中间件可以不断堆到堆栈中，其实就是堆到数组中，执行时也是按照先进先执行的方式进行，只不过每个中间件里都允许具备时间旅行的能力，可以先做自己的一部分事情，再去其他中间件继续做事情，全部做好之后再回来把自己剩下的事做完。</li><li>koa中间件为什么可以按use顺序依次执行？为什么中间件可以在依次执行的过程中暂停下来执行其他中间件完了以后又接着做？</li></ul><h3 id="koa-compose的纯函数与尾递归"><a href="#koa-compose的纯函数与尾递归" aria-hidden="true" class="header-anchor">#</a> Koa-Compose的纯函数与尾递归</h3><div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> compose

<span class="token keyword">function</span> <span class="token function">compose</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Middleware stack must be an array!'</span><span class="token punctuation">)</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Middleware must be composed of functions!'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// last called middleware #</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'next() called multiple times'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      index <span class="token operator">=</span> i
      <span class="token keyword">let</span> fn <span class="token operator">=</span> middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> middleware<span class="token punctuation">.</span>length<span class="token punctuation">)</span> fn <span class="token operator">=</span> next
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fn<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token function">next</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Koa-Compose：</p><ul><li>next看作一个钩子或回调函数，可以串联到下一个中间件</li><li>compose入参是一个纯函数</li><li>compose真正返回的是一个promise、</li><li>compose作用就是把一个个不相干的中间件给串在一起来组合函数，把这些函数串联起来执行，多个函数组合之后，前一个函数的输出结果就是后一个函数的输入参数。一旦第一个函数开始执行后，整个中间件的队列就像是多米诺骨牌一样，推到执行了。</li></ul><p>Koa小节：</p><ol><li>Koa中一切流程皆是中间件</li><li>一个HTTP请求进入Koa后，都会流经过预先配置好的中间件数组</li><li>在中间件执行策略中，是会通过Koa-Compose来把这些中间件组合在一起，一个接一个的把数组里面的函数依次执行，通过一个next钩子/回调函数，不断的将控制权/执行权进行往下传递。理解了Koa-Compose就是理解了Koa的洋葱模型</li><li>每一个中间件都会拿到整个HTTP请求的Context，通过context可以访问打request和response对象，而且可以访问到上面的属性和方法</li><li>贯穿中间件的请求上下文context、request、response三者互相引用，方便调用，request和response都是在node原生对象上扩展出来的</li></ol><h2 id="第4章-koa2-与-koa1-、express-框架对比"><a href="#第4章-koa2-与-koa1-、express-框架对比" aria-hidden="true" class="header-anchor">#</a> 第4章 Koa2 与 Koa1 、Express 框架对比</h2><h3 id="koa-与-express-选型"><a href="#koa-与-express-选型" aria-hidden="true" class="header-anchor">#</a> koa 与 express 选型</h3><ul><li>Koa是基于新的语法特性实现了Promise链传递，错误处理更友好。同时Koa不管任何中间件，是非常干净的、裸的框架，需要什么就加什么，而且Koa对流的支持度也非常好，通过对上下文对象的交叉引用，让内部的流程、请求和响应都能串联的更加紧凑。如果Express是大而全，则Koa就是小而精，两者定位不同。而且Koa的扩张性很好，稍微组装几个中间件就可以与Express匹敌，代码质量也很高，设计理念先进，语法特性超前。</li><li>从框架内部实现的角度来看，Koa与Express的中间件加载和实现机制是截然不同的，这点区别会让项目所用的中间件会走向两种不同的方式。故epxress能搞定的，koa同样能搞定，express能让你爽的，koa就能让你更爽。</li></ul><h2 id="第5章-从-0-开发一个电影预告片网站"><a href="#第5章-从-0-开发一个电影预告片网站" aria-hidden="true" class="header-anchor">#</a> 第5章 从 0 开发一个电影预告片网站</h2><h3 id="关于构建工具pracel解决的问题"><a href="#关于构建工具pracel解决的问题" aria-hidden="true" class="header-anchor">#</a> 关于构建工具pracel解决的问题</h3><p><img src="http://cdn.jerryshi.com//blog/2018/koa-5-7-001.png" alt="porject"></p><ul><li><code>npm i -S babel-preset-env babel-preset-stage-0 babel-preset-react</code></li><li><code>npm i -S babel-plugin-transform-decorators-legacy babel-plugin-transform-class-properties</code></li></ul><p>Parcel打包配置流程</p><ul><li>html引入index.js脚本</li><li>index.js中引入react和react-dom，写jsx</li><li>配置babel</li></ul><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;presets&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;targets&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;node&quot;</span><span class="token operator">:</span> <span class="token string">&quot;current&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;stage-0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;react&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;plugins&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;transform-runtime&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;polyfill&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token property">&quot;regenerator&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;transform-decorators-legacy&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;transform-class-properties&quot;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>配置npm脚本</li></ul><div class="language-jsson extra-class"><pre class="language-text"><code>{
  &quot;build&quot;: &quot;rimraf parcel/dist &amp;&amp; parcel build parcel/index.html --no-cache -d parcel/dist --public-url /dist/&quot;
}
</code></pre></div><h2 id="第6章-利用爬虫搞定网站基础数据"><a href="#第6章-利用爬虫搞定网站基础数据" aria-hidden="true" class="header-anchor">#</a> 第6章 利用爬虫搞定网站基础数据</h2><p><img src="http://cdn.jerryshi.com//blog/2018/dynamic_flow.png" alt="flow"></p><h3 id="利用puppeteer爬取和分析电影列表"><a href="#利用puppeteer爬取和分析电影列表" aria-hidden="true" class="header-anchor">#</a> 利用puppeteer爬取和分析电影列表</h3><pre><code>一个网站的价值其实是信息传递的价值，而信息的本质是数据。
可用性对于前端是一个比较敏感的词，说白了可用性就可以稳定性。
</code></pre><p>因为Node.js天生就是单线程的，所以我们就在主线程跑一个比较重的服务的话，比如说起一个内置浏览器来跑脚本，那么就会增加服务器挂断的风险，所以为了不让服务器断掉，我们会在服务器的主进程里再跑一个若干个子进程来干那些脏活累活，那么就算子进程挂了，而主进程还健在。</p><h3 id="同步和异步物理案例"><a href="#同步和异步物理案例" aria-hidden="true" class="header-anchor">#</a> 同步和异步物理案例</h3><pre><code>仅能简单对比，不是实际运行流畅。
</code></pre><p>故事铺垫：你和一个妹子合租一套两室一厅一卫的房子。</p><p>故事内容：某天早上你和妹子同时起床时，卫生间是闲置的，但两人都需要去洗漱，你要去洗澡，妹子要去刷牙，但只有一个卫生间，怎么办？</p><ul><li>方式一：妹子先在卫生间刷牙，你在门口等着，一直等到妹子刷完牙以后你再去洗澡。 ———— 同步阻塞</li><li>方式二：妹子在卫生间刷牙，我去看了一下，有人在用，你就走开了，但你会每间隔一段时间来看看卫生间用完没，一直到某次我看到卫生间没人了，你就去洗澡。———— 同步非阻塞 (其中每次过来看用完的行为称之为轮询)</li><li>对于等待的行为，方式一为阻塞，方式二为非阻塞</li><li>方式三：你在门上装了一个红外感应设备，只要你来卫生间门口看到有人在用，你就按下红外设备开关表示有人占用，待妹子用完出来时红外设备会自动通知你可以洗澡了。 ———— 异步非阻塞 (从主动轮休到被动通知，我跑去查看的行为从同步变为异步，那我做事的状态就从阻塞变为非阻塞)</li><li>方式三种按下红外感应设备行为代表我注册了一个回调函数，卫生间通知到你就代表执行回调</li><li>同步异步是过程，在于有无消息通知的机制，调用方是主动等待还被动通知进度，阻塞非阻塞是状态，是调用方在获取结果的过程中是干等还是各不耽误。</li><li>异步阻塞的调用模型是节约调用方时间的，而异步非阻塞就是node.js特点。</li></ul><h2 id="第7章-彩蛋篇-高难度拔高干货-深度理解-node-js-异步-io-模型"><a href="#第7章-彩蛋篇-高难度拔高干货-深度理解-node-js-异步-io-模型" aria-hidden="true" class="header-anchor">#</a> 第7章 彩蛋篇 - [高难度拔高干货] 深度理解 Node.js 异步 IO 模型</h2><p>IO：数据的进出。人机交互时，我们会把鼠标键盘这些外设视为Input输入，对于主机上会有专门信号的输入(物理)接口，显示器作为一个可视化的外设，对主机上则有专门的输出接口，这个就是我们显示的IO接口。</p><p>而在操作系统层面，则有磁盘读写，DNS查询，数据库连接，网络接收处理请求返回等，在不同操作系统中其表现形式也不一样，有的是存异步非阻塞，有的则是同步阻塞的，无论怎么样我们可以把IO看作上层应用和下层系统之间的数据交互，上层依赖于下层，上层可以对这些能力进一步定制和改造，如果这个交互是异步非阻塞的，那么这种就是**“异步IO模型”**，如果是同步的阻塞的，那么就是“同步IO模型”。</p><p>在Node.js同提到异步IO，我们可以拿文件读写为例，Koa是一个用JavaScript写的上层Web服务框架，其与操作系统的沟通读写能力都是建立在Node.js整个的通信服务模型之上，Node.js提供的“fs”模块，模块中提供了文件读写接口readFile是异步接口，它就是典型的异步IO接口，反之readFileSync就是一个阻塞的同步的IO接口。以其类推，我们站在上层Web服务器层面就很容易理解Node.js的异步非阻塞模型。</p><h2 id="第8章-实战篇-在-koa-中向-mongodb-建立数据模型"><a href="#第8章-实战篇-在-koa-中向-mongodb-建立数据模型" aria-hidden="true" class="header-anchor">#</a> 第8章 实战篇 - 在 Koa 中向 MongoDB 建立数据模型</h2><h2 id="第9章-实战篇-为网站增加路由与控制器层对外提供-api-服务"><a href="#第9章-实战篇-为网站增加路由与控制器层对外提供-api-服务" aria-hidden="true" class="header-anchor">#</a> 第9章 实战篇 - 为网站增加路由与控制器层对外提供 API 服务</h2><h3 id="_9-1"><a href="#_9-1" aria-hidden="true" class="header-anchor">#</a> 9-1</h3><p>这章我们专注于网站的核心业务，也就是网站的路由、数据的获取和数据的返回，即关于整个系统中后台的部分。那么对于一个后端服务来说，请求也就意味着HTTP请求接收和返回，处理接收和返回的能力在 <code>koa</code> 中主要借助于其上下文 <code>ctx</code> 以及众多的中间件完成，其中有处理会话的、有处理body解析的，还有处理路由的。</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">git</span> checkout master -b daily-9-1
<span class="token function">git</span> add <span class="token keyword">.</span>
<span class="token function">git</span> commit -m <span class="token string">''</span>
<span class="token function">git</span> push oirgin daily-9-1
</code></pre></div><h3 id="_9-2"><a href="#_9-2" aria-hidden="true" class="header-anchor">#</a> 9-2</h3><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/// koa-router的几种应用方式</span>
<span class="token comment">// 多个中间件</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">mid1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">mid2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/movies'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Category <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Category'</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>category <span class="token operator">=</span> <span class="token keyword">await</span> Category<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Movie <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Movie'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> movies <span class="token operator">=</span> <span class="token keyword">await</span> Movie<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">'meta.createAt'</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
    movies
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 加前缀</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  prefix<span class="token punctuation">:</span> <span class="token string">'/movies'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_9-3"><a href="#_9-3" aria-hidden="true" class="header-anchor">#</a> 9-3</h3><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Boy</span> <span class="token punctuation">{</span>
  @<span class="token function">speak</span><span class="token punctuation">(</span><span class="token string">'云南话'</span><span class="token punctuation">)</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I can run!'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'I can speak '</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lang<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">speak</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> descriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span>
    target<span class="token punctuation">.</span>lang <span class="token operator">=</span> lang

    <span class="token keyword">return</span> descriptor
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> jerry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Boy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

jerry<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/////////////////</span>
<span class="token comment">// Boy {}</span>
<span class="token comment">// run</span>
<span class="token comment">// { value: [Function: run],</span>
<span class="token comment">//   writable: true,</span>
<span class="token comment">//   enumerable: false,</span>
<span class="token comment">//   configurable: true }</span>
<span class="token comment">// I can run!</span>
<span class="token comment">// I can speak 云南话</span>
</code></pre></div><h2 id="第10章-实战篇-集成-antdesign-与-parcel-打通前后端与构建"><a href="#第10章-实战篇-集成-antdesign-与-parcel-打通前后端与构建" aria-hidden="true" class="header-anchor">#</a> 第10章 实战篇 - 集成 AntDesign 与 Parcel 打通前后端与构建</h2><h3 id="_10-1-配置babel-postcss-支持parcel打包"><a href="#_10-1-配置babel-postcss-支持parcel打包" aria-hidden="true" class="header-anchor">#</a> 10-1 配置babel postcss 支持parcel打包</h3><p>新建.postcssrc
<code>yarn add postcss-modules autoprefixer</code></p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;modules&quot;</span><span class="token keyword">:</span> true,
  <span class="token string">&quot;plugins&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;autoprefixer&quot;</span><span class="token keyword">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;grid&quot;</span><span class="token keyword">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="第11章-实战篇-实现网站前端路由与页面功能"><a href="#第11章-实战篇-实现网站前端路由与页面功能" aria-hidden="true" class="header-anchor">#</a> 第11章 实战篇 - 实现网站前端路由与页面功能</h2><h2 id="第12章-实战篇-实现后台登录权限与管理功能"><a href="#第12章-实战篇-实现后台登录权限与管理功能" aria-hidden="true" class="header-anchor">#</a> 第12章 实战篇 - 实现后台登录权限与管理功能</h2><h2 id="第13章-服务器部署与发布"><a href="#第13章-服务器部署与发布" aria-hidden="true" class="header-anchor">#</a> 第13章 服务器部署与发布</h2><h2 id="第14章-课程总结与展望"><a href="#第14章-课程总结与展望" aria-hidden="true" class="header-anchor">#</a> 第14章 课程总结与展望</h2></div><div class="page-edit"><!----><div class="last-updated"><span class="prefix">Last Updated: </span><span class="time">6/29/2018, 3:06:00 PM</span></div></div><!----></div></div></div>
    <script src="/assets/js/52.893d9d3e.js" defer></script><script src="/assets/js/app.d5e53e1d.js" defer></script>
  </body>
</html>
